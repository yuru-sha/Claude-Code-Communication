# プロジェクト成果物ダウンロード機能ガイド

## 概要

Task Pipeline にプロジェクトの成果物を ZIP 形式でダウンロードできる機能を追加しました。完了したタスクのプロジェクトから、workspace/以下に作成された全てのファイルとディレクトリを一括でダウンロードできます。

## 主要機能

### 🎯 プロジェクト Zip ダウンロード
- 完了タスクのプロジェクトディレクトリを丸ごと Zip 圧縮してダウンロード
- ファイル構造を保持したまま圧縮
- 日付付きファイル名で自動命名

### 🔒 セキュリティ機能
- パストラバーサル攻撃防止
- workspace/以外のディレクトリへのアクセス遮断
- 隠しファイル・システムファイルの自動除外

### 📁 ファイルフィルタリング
以下のファイル・ディレクトリは自動的に除外されます：
- 隠しファイル（.で始まるファイル）
- node_modules/
- .git/
- __pycache__/
- その他のシステムファイル

## 使用方法

### 1. 基本的な使い方
1. Task Pipeline で完了（completed）状態のタスクを確認
2. プロジェクト名が表示されているタスクカードを探す
3. プロジェクト名の横にある「ダウンロード」ボタン（⬇️アイコン）をクリック
4. ブラウザで Zip ファイルのダウンロードが開始されます

### 2. ダウンロードされるファイル名
```
{プロジェクト名}-{YYYY-MM-DD}.zip
```
例：`sample-project-2025-01-27.zip`

### 3. 対象タスク
- ステータスが「completed」のタスクのみ
- プロジェクト名（projectName）が設定されているタスクのみ

## 技術仕様

### API エンドポイント

#### 1. プロジェクトファイル一覧取得
```
GET /api/projects/{projectName}/files
```
**レスポンス例：**
```json
{
  "name": "sample-project",
  "path": "/path/to/workspace/sample-project",
  "files": [
    {
      "path": "README.md",
      "name": "README.md",
      "size": 623,
      "type": "file",
      "modified": "2025-01-27T12:23:34.673Z"
    },
    {
      "path": "src",
      "name": "src",
      "size": 0,
      "type": "directory",
      "modified": "2025-01-27T12:23:54.280Z"
    }
  ],
  "totalSize": 2477,
  "lastModified": "2025-01-27T12:24:06.328Z"
}
```

#### 2. プロジェクト Zip ダウンロード
```
GET /api/projects/{projectName}/download/zip
```
**レスポンス：** ZIP 形式のバイナリデータ

### 実装アーキテクチャ

#### バックエンド（Node.js + Express）
- **archiver**: ZIP 圧縮ライブラリ
- **fs/promises**: ファイルシステム操作
- **path**: パス操作とセキュリティチェック

#### フロントエンド（React + TypeScript）
- **downloadProjectAsZip**: プロジェクトダウンロード関数
- **TaskPipeline**: UI コンポーネント統合
- **CSS**: ダウンロードボタンのスタイリング

## ファイル構成

```
src/
├── backend/
│   └── server.ts               # ダウンロード API 実装
├── frontend/
│   ├── components/
│   │   └── TaskPipeline.tsx    # UI コンポーネント
│   ├── utils/
│   │   └── projectDownloadUtils.ts  # ダウンロード処理
│   └── styles/
│       └── dashboard.css       # ダウンロードボタンスタイル
└── types/
    └── index.ts               # 型定義
```

## エラーハンドリング

### よくあるエラーと対処法

#### 1. プロジェクトが見つからない
**エラー：** "Project not found"
**原因：** 指定されたプロジェクト名のディレクトリが存在しない
**対処法：** プロジェクト名を確認し、workspace/以下にディレクトリが存在することを確認

#### 2. ダウンロードに失敗
**エラー：** "Failed to create zip archive"
**原因：** ファイルアクセス権限、ディスク容量不足等
**対処法：** サーバーログを確認し、権限やディスク容量をチェック

#### 3. アクセス拒否
**エラー：** "Access denied"
**原因：** パストラバーサル攻撃の可能性でセキュリティブロック
**対処法：** 正しいプロジェクト名を使用する

## パフォーマンス考慮事項

### 大容量プロジェクトの処理
- 圧縮レベル: 最高（level 9）で品質重視
- メモリ使用量: ストリーミング処理でメモリ効率化
- タイムアウト: 大容量ファイルでもブラウザタイムアウトを防止

### 推奨事項
- プロジェクトサイズ: 100MB 以下を推奨
- ファイル数: 1000 ファイル以下を推奨
- 大容量の場合は分割ダウンロードを検討

## セキュリティガイドライン

### 実装済みセキュリティ対策
1. **パストラバーサル防止**: `../`を使った上位ディレクトリアクセスを防止
2. **アクセス範囲制限**: workspace/ディレクトリ以外へのアクセスを制限
3. **ファイルタイプ制限**: 安全でないファイルの自動除外
4. **入力値検証**: プロジェクト名の妥当性チェック

### 追加推奨事項
1. 定期的なログ監視
2. ダウンロード履歴の記録
3. 異常なアクセスパターンの検出

## 今後の拡張計画

### 短期的改善
- [ ] ダウンロード進捗表示
- [ ] 複数プロジェクトの一括ダウンロード
- [ ] ファイル選択ダウンロード

### 中期的改善
- [ ] ダウンロード履歴機能
- [ ] ダウンロード統計
- [ ] 圧縮レベル選択

### 長期的改善
- [ ] クラウドストレージ連携
- [ ] CDN 配信
- [ ] 差分ダウンロード

## トラブルシューティング

### よくある問題

#### Q: ダウンロードボタンが表示されない
A: タスクのステータスが「completed」かつプロジェクト名が設定されているか確認してください。

#### Q: Zip ファイルが空になる
A: プロジェクトディレクトリにファイルが存在するか、権限設定を確認してください。

#### Q: ダウンロード中にエラーが発生
A: ブラウザの開発者ツールのネットワークタブでエラー詳細を確認してください。

## サポート

問題が発生した場合は、以下の情報を含めて報告してください：
1. 発生したエラーメッセージ
2. プロジェクト名
3. ブラウザとバージョン
4. サーバーログ（可能な場合）

## 更新履歴

- **v1.0.0** (2025-01-27): 初回リリース
  - プロジェクト Zip ダウンロード機能
  - セキュリティ対策実装
  - UI 統合完了